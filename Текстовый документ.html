<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —á–∏—Å—Ç–æ—Ç—ã –ö–∞—Å–ø–∏–π—Å–∫–æ–≥–æ –ø–æ–±–µ—Ä–µ–∂—å—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #controls { position: fixed; top: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        #stats { position: fixed; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        button { margin: 5px; padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
        #modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; }
        input, select, textarea { width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; }
        .admin-only { display: none; }
        .status-new { color: red; }
        .status-inwork { color: orange; }
        .status-cleaned { color: green; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="controls">
        <button id="reportBtn">üö® –°–æ–æ–±—â–∏—Ç—å –æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–∏</button>
        <div id="adminPanel">
            <input type="password" id="adminPass" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞">
            <button id="adminLogin">–í–æ–π—Ç–∏</button>
            <button id="adminLogout" style="background: #f44336;">–í—ã–π—Ç–∏</button>
            <button id="exportBtn" class="admin-only">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
    </div>
    
    <div id="stats">
        <div>üìç –ù–æ–≤—ã—Ö: <span id="countNew">0</span></div>
        <div>üîß –í —Ä–∞–±–æ—Ç–µ: <span id="countInwork">0</span></div>
        <div>‚úÖ –û—á–∏—â–µ–Ω–æ: <span id="countCleaned">0</span></div>
    </div>
    
    <div id="modal">
        <div id="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è</h3>
            <form id="reportForm">
                <label>–¢–∏–ø:</label>
                <select id="type">
                    <option>–ú—É—Å–æ—Ä (–±—ã—Ç–æ–≤–æ–π)</option>
                    <option>–ù–µ—Ñ—Ç—è–Ω–æ–µ –ø—è—Ç–Ω–æ</option>
                    <option>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ –æ—Ç—Ö–æ–¥—ã</option>
                    <option>–î—Ä—É–≥–æ–µ</option>
                </select>
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="desc" placeholder="–ß—Ç–æ —É–≤–∏–¥–µ–ª–∏?"></textarea>
                <label>–§–æ—Ç–æ:</label>
                <input type="file" id="photo" accept="image/*">
                <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" id="cancelBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <script>
        // –ò–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        const trashIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });
        const oilIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });

        // –ö–∞—Ä—Ç–∞ –ö–∞—Å–ø–∏—è
        const map = L.map('map').setView([41.5, 50.5], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let currentLatLng = null;
        let markers = {};
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        const STORAGE_KEY = 'kaspii_pollutions';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            const dataStr = localStorage.getItem(STORAGE_KEY);
            return dataStr ? JSON.parse(dataStr) : [];
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // –†–µ–Ω–¥–µ—Ä –º–∞—Ä–∫–µ—Ä–æ–≤
        function renderMarkers() {
            const data = loadData();
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            let countNew = 0, countInwork = 0, countCleaned = 0;
            data.forEach((item, index) => {
                const icon = item.type === '–ù–µ—Ñ—Ç—è–Ω–æ–µ –ø—è—Ç–Ω–æ' ? oilIcon : trashIcon;
                const marker = L.marker([item.lat, item.lng], {icon}).addTo(map);
                let statusClass = '';
                let statusBtn = '';
                if (isAdmin) {
                    statusBtn = `
                        <br><button onclick="setStatus(${index}, 'inwork')" style="background:orange;">üîß –í —Ä–∞–±–æ—Ç–µ</button>
                        <button onclick="setStatus(${index}, 'cleaned')" style="background:green;">‚úÖ –û—á–∏—â–µ–Ω–æ</button>
                    `;
                }
                if (item.status === 'new') { countNew++; statusClass = 'status-new'; }
                else if (item.status === 'inwork') { countInwork++; statusClass = 'status-inwork'; }
                else if (item.status === 'cleaned') { countCleaned++; statusClass = 'status-cleaned'; }

                const photoHtml = item.photo ? <img src="${item.photo}" style="max-width:150px;"><br> : '';
                marker.bindPopup(`
                    <b>${item.type}</b><br>
                    ${photoHtml}
                    ${item.desc}<br>
                    <span class="${statusClass}">–°—Ç–∞—Ç—É—Å: ${item.status}</span>
                    ${statusBtn}
                `);
                markers[index] = marker;
            });

            document.getElementById('countNew').textContent = countNew;
            document.getElementById('countInwork').textContent = countInwork;
            document.getElementById('countCleaned').textContent = countCleaned;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderMarkers();

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –Ω–∞ –∫–ª–∏–∫
        document.getElementById('reportBtn').onclick = () => {
            map.once('click', (e) => {
                currentLatLng = e.latlng;
                document.getElementById('modal').style.display = 'block';
            });
        };

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ—á–∫—É
        document.getElementById('reportForm').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('type').value;
            const desc = document.getElementById('desc').value;
            const file = document.getElementById('photo').files[0];

            let photoUrl = '';
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoUrl = e.target.result; // base64
                    savePoint();
                };
                reader.readAsDataURL(file);
            } else {
                savePoint();
            }

            function savePoint() {
                const data = loadData();
                data.unshift({
                    lat: currentLatLng.lat,
                    lng: currentLatLng.lng,
                    type, desc, photo: photoUrl,
                    status: 'new',
                    time: new Date().toISOString()
                });
                saveData(data);
                renderMarkers();
                document.getElementById('modal').style.display = 'none';
                document.getElementById('reportForm').reset();
            }
        };

        document.getElementById('cancelBtn').onclick = () => {
            document.getElementById('modal').style.display = 'none';
        };

        // –ê–¥–º–∏–Ω
        document.getElementById('adminLogin').onclick = () => {
            if (document.getElementById('adminPass').value === 'admin123') {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                document.querySelector('.admin-only').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'block';
                renderMarkers(); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        };

        document.getElementById('adminLogout').onclick = () => {
            isAdmin = false;
            localStorage.removeItem('isAdmin');
            document.querySelector('.admin-only').style.display = 'none';
            renderMarkers();
            location.reload();
        };

        if (isAdmin) {
            document.getElementById('adminPanel').style.display = 'block';
            document.querySelector('.admin-only').style.display = 'block';
        }

        // –≠–∫—Å–ø–æ—Ä—Ç CSV
        document.getElementById('exportBtn').onclick = () => {
            const data = loadData();
            let csv = 'lat,lng,type,desc,status,time\n';
            data.forEach((item) => {
                csv += ${item.lat},${item.lng},"${item.type}","${item.desc.replace(/"/g, '""')}","${item.status}","${item.time}"\n;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kaspii_pollutions.csv';
            a.click();
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
        window.setStatus = (index, status) => {
            const data = loadData();
            data[index].status = status;
            saveData(data);
            renderMarkers();
        };
    </script>
</body>
</html>